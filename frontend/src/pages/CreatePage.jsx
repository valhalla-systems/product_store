// ‚úÖ ARQUIVO: frontend/src/pages/CreatePage.jsx
// ----------------------------------------------------------
// P√°gina de cria√ß√£o de produtos com hook useImageUploader
// ----------------------------------------------------------

import {
  Box,
  Button,
  Container,
  Heading,
  Image,
  Input,
  useColorModeValue,
  useToast,
  VStack,
  Spinner,
  Text,
  FormControl,
  FormLabel,
} from "@chakra-ui/react";
import { useRef, useState } from "react";
import { useProductStore } from "../store/product";
import { useImageUploader } from "../hooks/useImageUploader";

const CreatePage = () => {
  const [newProduct, setNewProduct] = useState({
    name: "",
    price: "",
  });
  const [isLoading, setIsLoading] = useState(false);

  const toast = useToast();
  const { createProduct } = useProductStore();
  const fileInputRef = useRef(null);

  // ü™ù Hook customizado para upload e compress√£o
  const {
    preview,
    setPreview,
    file,
    setFile,
    isImageLoading,
    isCompressing,
    handleImageChange,
  } = useImageUploader();

  const handleAddProduct = async () => {
    if (!newProduct.name.trim() || !newProduct.price || !file) {
      toast({
        title: "Campos obrigat√≥rios",
        description: "Preencha nome, pre√ßo e selecione uma imagem.",
        status: "warning",
        duration: 3000,
        isClosable: true,
      });
      return;
    }

    setIsLoading(true);

    // üîß Convers√£o segura de pre√ßo para n√∫mero
    const productToSend = {
      ...newProduct,
      price: parseFloat(newProduct.price),
      image: file,
    };

    const { success, message } = await createProduct(productToSend);

    toast({
      title: success ? "Sucesso ‚úÖ" : "Erro ‚ùå",
      description: success
        ? `O produto "${newProduct.name}" foi criado com sucesso!`
        : message,
      status: success ? "success" : "error",
      duration: 3000,
      isClosable: true,
    });

    if (success) {
      setNewProduct({ name: "", price: "" });

      // Reset do input e do hook
      if (fileInputRef.current) fileInputRef.current.value = "";
      setPreview(null);
      setFile(null);
    }

    setIsLoading(false);
  };

  return (
    <Container maxW="container.sm" py={10}>
      <VStack spacing={8}>
        <Heading as="h1" size="2xl" textAlign="center">
          Criar Novo Produto
        </Heading>

        <Box
          w="full"
          bg={useColorModeValue("white", "gray.800")}
          p={6}
          rounded="lg"
          shadow="md"
        >
          <VStack spacing={5} align="stretch">
            {/* Nome */}
            <FormControl isRequired>
              {/*<FormLabel htmlFor="name">Nome do Produto</FormLabel>*/}
              <Input
                id="name"
                name="name"
                placeholder="Nome do Produto"
                value={newProduct.name}
                onChange={(e) =>
                  setNewProduct({ ...newProduct, name: e.target.value })
                }
              />
            </FormControl>

            {/* Pre√ßo */}
            <FormControl isRequired>
              {/*<FormLabel htmlFor="price">Pre√ßo</FormLabel>*/}
              <Input
                id="price"
                name="price"
                placeholder="Pre√ßo"
                type="number"
                min="0"
                value={newProduct.price}
                onChange={(e) =>
                  setNewProduct({ ...newProduct, price: e.target.value })
                }
              />
            </FormControl>

            {/* Upload */}
            <FormControl isRequired>
              {/*<FormLabel htmlFor="image">Imagem do Produto</FormLabel>*/}
              <Input
                id="image"
                name="image"
                type="file"
                ref={fileInputRef}
                accept="image/*"
                onChange={handleImageChange}
              />
            </FormControl>

            {/* Preview */}
            {preview && (
              <Box
                position="relative"
                w="full"
                h="200px"
                display="flex"
                alignItems="center"
                justifyContent="center"
                borderRadius="md"
                overflow="hidden"
              >
                {isImageLoading && (
                  <Box
                    position="absolute"
                    inset="0"
                    display="flex"
                    alignItems="center"
                    justifyContent="center"
                    bg="rgba(0,0,0,0.3)"
                    zIndex="1"
                  >
                    <VStack spacing={2}>
                      <Spinner size="xl" color="white" />
                      <Text color="white">Carregando imagem...</Text>
                    </VStack>
                  </Box>
                )}

                <Image
                  src={preview}
                  alt="Pr√©-visualiza√ß√£o"
                  maxH="200px"
                  objectFit="contain"
                  borderRadius="md"
                  shadow="sm"
                  onLoad={() => {}}
                />
              </Box>
            )}

            {/* Bot√£o de envio */}
            <Button
              colorScheme="blue"
              onClick={handleAddProduct}
              w="full"
              isLoading={isLoading || isCompressing}
              loadingText={isCompressing ? "Comprimindo..." : "Adicionando..."}
              isDisabled={
                !newProduct.name || !newProduct.price || !file || isCompressing
              }
            >
              Adicionar Produto
            </Button>
          </VStack>
        </Box>
      </VStack>
    </Container>
  );
};

export default CreatePage;
